From 737106be95a4b1f7aa1f92164f09dc435ae0dfdb Mon Sep 17 00:00:00 2001
From: metacritical <pankajdoharey@gmail.com>
Date: Tue, 23 Dec 2025 19:24:30 +0530
Subject: [PATCH] feat(tml): Migrate buffer_ui.sh to TML parser

- Created buffer-ui.xml layout for streaming buffer status
- Integrated TML parser into buffer_ui.sh
- Note: --listen port added inline (dynamic per-session)
- Old hardcoded FZF config commented for reference
---
 modules/streaming/buffer_ui.sh   | 65 ++++++++++++++++++++------------
 modules/ui/layouts/buffer-ui.xml | 15 ++++----
 2 files changed, 47 insertions(+), 33 deletions(-)

diff --git a/modules/streaming/buffer_ui.sh b/modules/streaming/buffer_ui.sh
index 75c0627..abe0e03 100644
--- a/modules/streaming/buffer_ui.sh
+++ b/modules/streaming/buffer_ui.sh
@@ -458,32 +458,47 @@ PREVIEW_EOF
         rm -f "$status_file" "$preview_script" 2>/dev/null
     }

+    # ════════════════════════════════════════════════════════════════
+    # TML Parser Integration (Buffer UI)
+    # ════════════════════════════════════════════════════════════════
+    export title
+    local UI_DIR="${BASH_SOURCE%/*}/../ui"
+    source "${UI_DIR}/tml/parser/tml_parser.sh"
+    tml_parse "${UI_DIR}/layouts/buffer-ui.xml"
+    local fzf_args=$(tml_get_fzf_args)
+
     # Launch Stage 2 FZF with listen port for API updates
-    printf "%s" "$options" | fzf \
-        --ansi \
-        --delimiter='|' \
-        --with-nth=2 \
-        --height=100% \
-        --layout=reverse \
-        --border=rounded \
-        --margin=1 \
-        --padding=1 \
-        --border-label=" Esc:Back " \
-        --border-label-pos=bottom \
-        --prompt='⬇ Buffering ' \
-        --pointer='➤' \
-        --header="Streaming: ${title}" \
-        --header-first \
-        --color=fg:#f8f8f2,bg:-1,hl:#ff79c6 \
-        --color=fg+:#ffffff,bg+:#44475a,hl+:#ff79c6 \
-        --color=info:#bd93f9,prompt:#50fa7b,pointer:#ff79c6 \
-        --listen "$fzf_port" \
-        --preview "$preview_script" \
-        --preview-window=left:55%:wrap:border-right \
-        --bind='enter:accept' \
-        --bind='esc:abort' \
-        --bind='ctrl-c:abort' \
-        >/dev/null 2>&1
+    # Note: --listen is added inline since port is dynamic per-session
+    printf "%s" "$options" | eval "fzf --ansi $fzf_args --listen $fzf_port --preview \"$preview_script\" --bind='ctrl-c:abort'" >/dev/null 2>&1
+
+    # ════════════════════════════════════════════════════════════════
+    # OLD HARDCODED FZF CONFIG (commented for reference)
+    # ════════════════════════════════════════════════════════════════
+    # printf "%s" "$options" | fzf \
+    #     --ansi \
+    #     --delimiter='|' \
+    #     --with-nth=2 \
+    #     --height=100% \
+    #     --layout=reverse \
+    #     --border=rounded \
+    #     --margin=1 \
+    #     --padding=1 \
+    #     --border-label=" Esc:Back " \
+    #     --border-label-pos=bottom \
+    #     --prompt='⬇ Buffering ' \
+    #     --pointer='➤' \
+    #     --header="Streaming: ${title}" \
+    #     --header-first \
+    #     --color=fg:#f8f8f2,bg:-1,hl:#ff79c6 \
+    #     --color=fg+:#ffffff,bg+:#44475a,hl+:#ff79c6 \
+    #     --color=info:#bd93f9,prompt:#50fa7b,pointer:#ff79c6 \
+    #     --listen "$fzf_port" \
+    #     --preview "$preview_script" \
+    #     --preview-window=left:55%:wrap:border-right \
+    #     --bind='enter:accept' \
+    #     --bind='esc:abort' \
+    #     --bind='ctrl-c:abort' \
+    #     >/dev/null 2>&1

     local fzf_exit=$?

diff --git a/modules/ui/layouts/buffer-ui.xml b/modules/ui/layouts/buffer-ui.xml
index bbb2fff..080bdff 100644
--- a/modules/ui/layouts/buffer-ui.xml
+++ b/modules/ui/layouts/buffer-ui.xml
@@ -1,16 +1,16 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <!--
   Buffer UI Layout
-  Shows streaming buffer status with live preview
+  For streaming buffer status display with live preview updates
+  Special: Uses FZF listen port for API-driven refresh
 -->
 <fzf-layout id="buffer-ui" name="Buffer UI">
-  <layout direction="reverse" height="100%" margin="1" padding="1" info="hidden"/>
-  <preview position="left" size="55%" wrap="true" border="border-right"
-            script="${preview_script:-}"/>
-  <header first="true">Streaming: ${title:-Title}</header>
+  <layout direction="reverse" height="100%" margin="1" padding="1"/>
   <border style="rounded" label=" Esc:Back " label-pos="bottom"/>
-  <prompt pointer="➤">⬇ Buffering</prompt>
-  <colors theme="dracula">
+  <prompt pointer="➤">⬇ Buffering </prompt>
+  <header first="true">Streaming: ${title:-Movie}</header>
+  <preview position="left" size="55%" wrap="true" border="border-right"/>
+  <colors>
     <color name="fg" value="#f8f8f2"/>
     <color name="bg" value="-1"/>
     <color name="hl" value="#ff79c6"/>
@@ -24,6 +24,5 @@
   <bindings delimiter="|" with-nth="2">
     <bind key="enter" action="accept"/>
     <bind key="esc" action="abort"/>
-    <bind key="ctrl-c" action="abort"/>
   </bindings>
 </fzf-layout>
--
2.50.1 (Apple Git-155)

