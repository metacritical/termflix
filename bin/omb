#!/usr/bin/env bash
#
# Oh My Bash - Unified Help System
# Usage: omb [command] [topic]
#

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[0;37m'
BOLD='\033[1m'
RESET='\033[0m'

# Framework root
OH_MY_BASH="${OH_MY_BASH:-$(dirname "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")")")}"

# Help database
HELP_DB="$OH_MY_BASH/.help_db"

# Initialize help database if it doesn't exist
init_help_db() {
    if [ ! -f "$HELP_DB" ]; then
        cat > "$HELP_DB" <<'EOF'
# Oh My Bash Help Database
# Format: TYPE|NAME|DESCRIPTION|USAGE|CATEGORY

# Commands
CMD|ansi_color|Display ANSI color codes|ansi_color|colors
CMD|battery|Display battery status|battery|system
CMD|cdx|Change directory with spinner|cdx [dir]|navigation
CMD|color_py|Python color utility|color_py|colors
CMD|crop|Crop images| crop [file]|media
CMD|cx|Execute C programs from command line|cx [file.c ...] [args]|development
CMD|d|Docker utility with SCM Breeze style|d [command]|docker
CMD|d.sh|Docker helper script|d.sh [command]|docker
CMD|dc|Docker Compose helper|dc [command]|docker
CMD|dd|Docker helper|dd [command]|docker
CMD|emacs_stop|Stop Emacs server|emacs_stop|editor
CMD|emacscl|Emacs client|emacscl|editor
CMD|emacsw|Emacs wrapper|emacsw|editor
CMD|git_tree|Git tree visualization|git_tree|git
CMD|git-tree|Git tree alias|git-tree|git
CMD|gits|Git status prompt utility|gits [prompt]|git
CMD|img2ascii|Convert images to ASCII art|img2ascii [file]|media
CMD|imgconvert|Image conversion utility|imgconvert [file]|media
CMD|install_font|Install fonts|install_font [font]|system
CMD|killport|Kill process on port|killport [port]|system
CMD|lein|Leiningen wrapper|lein [command]|development
CMD|lein-exec|Execute Clojure code|lein-exec [code]|development
CMD|lock_me|Lock screen|lock_me|system
CMD|mux_clock|Tmux clock display|mux_clock|tmux
CMD|nullpass|Password generator|nullpass [options]|security
CMD|open|Open files/URLs|open [target]|system
CMD|open_brew_emacs|Open Emacs via Homebrew|open_brew_emacs|editor
CMD|pcp|Portable copy utility|pcp [src] [dst]|system
CMD|rand_images|Display random images|rand_images [dir]|media
CMD|rand_numb|Generate random number|rand_numb [min] [max]|utilities
CMD|resize|Resize images|resize [file] [size]|media
CMD|ruby_current|Show current Ruby version|ruby_current|development
CMD|serve|Simple HTTP server|serve [dir] [port]|development
CMD|startup_scripts|Run startup scripts|startup_scripts|system
CMD|term_color|Display terminal colors|term_color|colors
CMD|tinyurl|Create tiny URL|tinyurl [url]|utilities
CMD|tp|Text processing utility|tp [file]|utilities
CMD|transcode|Transcode media files|transcode [file]|media
CMD|truck|File transfer utility|truck [src] [dst]|system
CMD|unicode_char|Unicode character utility|unicode_char [code]|utilities

# Aliases
ALIAS|_|sudo alias|_ [command]|system
ALIAS|ls|ls with color|ls [options]|file
ALIAS|la|ls -A with color|la [options]|file
ALIAS|db:sup|rake db:setup|db:sup|development
ALIAS|db:red|rake db:migrate:redo|db:red|development
ALIAS|rmrf|rm -rf|rmrf [target]|file
ALIAS|ccat|e2ansi-cat|ccat [file]|file
ALIAS|rs|rails server|rs|development
ALIAS|rc|rails console|rc|development
ALIAS|ss|script/server|ss|development
ALIAS|sc|script/console|sc|development
ALIAS|emacs|emacs -nw|emacs [file]|editor
ALIAS|tmux|tmux with TERM setting|tmux [command]|tmux
ALIAS|:q|exit 0|:q|navigation
ALIAS|:Q|exit 0|:Q|navigation
ALIAS|rgrep|grep with color and context|rgrep [pattern] [file]|file
ALIAS|~|cd ~|~|navigation
ALIAS|..|cd ../..|..|navigation
ALIAS|...|cd ../../..|...|navigation
ALIAS|....|cd ../../../..|....|navigation
ALIAS|cljs|ClojureScript REPL|cljs|development
ALIAS|cljrebl|Clojure with REBL|cljrebl|development
ALIAS|cljsrebl|ClojureScript with REBL|cljsrebl|development
ALIAS|serve|Ruby HTTP server|serve [dir]|development
ALIAS|less|less with raw control chars|less [file]|file
ALIAS|fig|rlwrap lein figwheel|fig|development
ALIAS|csi|rlwrap csi|csi|development
ALIAS|pg-start|Start PostgreSQL|pg-start|development
ALIAS|pg-stop|Stop PostgreSQL|pg-stop|development
ALIAS|pflx|Peerflix torrent|pflx|media
ALIAS|icloudrive|cd to iCloud Drive|icloudrive|navigation
ALIAS|screen_record|Start screen recording|screen_record|media

# Functions
FUNC|src|Reload bash profile|src|system
FUNC|unblock|Kill process on port|unblock [port]|system
FUNC|timeloop|Loop command with timeout|timeloop [command]|utilities
FUNC|code|Open in code editor|code [file]|editor
FUNC|disp_msg|Display message utility|disp_msg [message]|utilities
FUNC|alert|Notification for long commands|alert|utilities
FUNC|trapper|Trap signals|trapper|system
FUNC|command_not_found_handle|Handle command not found|command_not_found_handle|system
FUNC|tmux_status_left|Tmux status bar left|tmux_status_left|tmux

# Libraries
LIB|aliases.sh|Command aliases|source libs/aliases.sh|core
LIB|bind_key.sh|Key bindings|source libs/bind_key.sh|core
LIB|colors.sh|Color definitions|source libs/colors.sh|core
LIB|prompt.sh|PS1 prompt configuration|source libs/prompt.sh|core
LIB|command_not_found_handle.sh|Command not found handler|source libs/command_not_found_handle.sh|core
LIB|tmux_status_left.sh|Tmux status configuration|source libs/tmux_status_left.sh|tmux
LIB|trapper.sh|Signal trapping|source libs/trapper.sh|core
LIB|tmux.conf|Tmux configuration|source libs/tmux.conf|tmux

# Utilities
UTIL|alert.sh|Alert notification utility|source utils/alert.sh|utilities
UTIL|clock.sh|Clock display utility|source utils/clock.sh|utilities
UTIL|code.sh|Code editor utility|source utils/code.sh|editor
UTIL|disp_msg.sh|Message display utility|source utils/disp_msg.sh|utilities
EOF
    fi
}

# Load help database
load_help_db() {
    if [ ! -f "$HELP_DB" ]; then
        init_help_db
    fi
    
    # Check bash version for associative arrays
    if [ "${BASH_VERSION%%.*}" -ge 4 ] 2>/dev/null; then
        # Use associative arrays (bash 4+)
        declare -A commands
        declare -A aliases
        declare -A functions
        declare -A libraries
        declare -A utilities
        
        # Read database into arrays
        while IFS='|' read -r type name desc usage category; do
            # Skip comments and empty lines
            [[ "$type" =~ ^#.*$ ]] && continue
            [[ -z "$type" ]] && continue
            
            case "$type" in
                CMD) commands["$name"]="$desc|$usage|$category" ;;
                ALIAS) aliases["$name"]="$desc|$usage|$category" ;;
                FUNC) functions["$name"]="$desc|$usage|$category" ;;
                LIB) libraries["$name"]="$desc|$usage|$category" ;;
                UTIL) utilities["$name"]="$desc|$usage|$category" ;;
            esac
        done < "$HELP_DB"
        
        # Export arrays (workaround for bash 3)
        export OMB_COMMANDS=$(printf '%s\n' "${!commands[@]}" | while read k; do echo "$k|${commands[$k]}"; done)
        export OMB_ALIASES=$(printf '%s\n' "${!aliases[@]}" | while read k; do echo "$k|${aliases[$k]}"; done)
        export OMB_FUNCTIONS=$(printf '%s\n' "${!functions[@]}" | while read k; do echo "$k|${functions[$k]}"; done)
        export OMB_LIBRARIES=$(printf '%s\n' "${!libraries[@]}" | while read k; do echo "$k|${libraries[$k]}"; done)
        export OMB_UTILITIES=$(printf '%s\n' "${!utilities[@]}" | while read k; do echo "$k|${utilities[$k]}"; done)
    else
        # Fallback for bash 3: use files
        mkdir -p "$OH_MY_BASH/.help_cache"
        grep "^CMD|" "$HELP_DB" > "$OH_MY_BASH/.help_cache/commands"
        grep "^ALIAS|" "$HELP_DB" > "$OH_MY_BASH/.help_cache/aliases"
        grep "^FUNC|" "$HELP_DB" > "$OH_MY_BASH/.help_cache/functions"
        grep "^LIB|" "$HELP_DB" > "$OH_MY_BASH/.help_cache/libraries"
        grep "^UTIL|" "$HELP_DB" > "$OH_MY_BASH/.help_cache/utilities"
    fi
}

# Search help database
search_help() {
    local query="$1"
    local results=()
    
    if [ "${BASH_VERSION%%.*}" -ge 4 ] 2>/dev/null; then
        # Use associative arrays (bash 4+)
        # Search commands
        for cmd in "${!commands[@]}"; do
            if [[ "$cmd" =~ $query ]] || [[ "${commands[$cmd]}" =~ $query ]]; then
                results+=("CMD|$cmd|${commands[$cmd]}")
            fi
        done
        
        # Search aliases
        for alias in "${!aliases[@]}"; do
            if [[ "$alias" =~ $query ]] || [[ "${aliases[$alias]}" =~ $query ]]; then
                results+=("ALIAS|$alias|${aliases[$alias]}")
            fi
        done
        
        # Search functions
        for func in "${!functions[@]}"; do
            if [[ "$func" =~ $query ]] || [[ "${functions[$func]}" =~ $query ]]; then
                results+=("FUNC|$func|${functions[$func]}")
            fi
        done
        
        # Search libraries
        for lib in "${!libraries[@]}"; do
            if [[ "$lib" =~ $query ]] || [[ "${libraries[$lib]}" =~ $query ]]; then
                results+=("LIB|$lib|${libraries[$lib]}")
            fi
        done
        
        # Search utilities
        for util in "${!utilities[@]}"; do
            if [[ "$util" =~ $query ]] || [[ "${utilities[$util]}" =~ $query ]]; then
                results+=("UTIL|$util|${utilities[$util]}")
            fi
        done
    else
        # Fallback for bash 3: use grep directly on database
        while IFS= read -r line; do
            [[ -z "$line" ]] && continue
            [[ "$line" =~ ^#.*$ ]] && continue
            results+=("$line")
        done < <(grep -i "$query" "$HELP_DB" 2>/dev/null | head -20)
    fi
    
    printf '%s\n' "${results[@]}"
}

# Display help for a specific item
show_item_help() {
    local type="$1"
    local name="$2"
    local info="$3"
    
    IFS='|' read -r desc usage category <<< "$info"
    
    local type_color="$CYAN"
    local type_label=""
    case "$type" in
        CMD) type_color="$GREEN"; type_label="Command" ;;
        ALIAS) type_color="$YELLOW"; type_label="Alias" ;;
        FUNC) type_color="$MAGENTA"; type_label="Function" ;;
        LIB) type_color="$BLUE"; type_label="Library" ;;
        UTIL) type_color="$BLUE"; type_label="Utility" ;;
    esac
    
    echo -e "${BOLD}${type_color}${type_label}:${RESET} ${BOLD}$name${RESET}"
    echo -e "  ${WHITE}Description:${RESET} $desc"
    echo -e "  ${WHITE}Usage:${RESET} $usage"
    echo -e "  ${WHITE}Category:${RESET} $category"
    echo
}

# Show category help
show_category() {
    local category="$1"
    local found=false
    
    echo -e "${BOLD}${BLUE}Category: $category${RESET}\n"
    
    if [ "${BASH_VERSION%%.*}" -ge 4 ] 2>/dev/null; then
        # Commands
        for cmd in "${!commands[@]}"; do
            IFS='|' read -r desc usage cat <<< "${commands[$cmd]}"
            if [ "$cat" = "$category" ]; then
                show_item_help "CMD" "$cmd" "${commands[$cmd]}"
                found=true
            fi
        done
        
        # Aliases
        for alias in "${!aliases[@]}"; do
            IFS='|' read -r desc usage cat <<< "${aliases[$alias]}"
            if [ "$cat" = "$category" ]; then
                show_item_help "ALIAS" "$alias" "${aliases[$alias]}"
                found=true
            fi
        done
        
        # Functions
        for func in "${!functions[@]}"; do
            IFS='|' read -r desc usage cat <<< "${functions[$func]}"
            if [ "$cat" = "$category" ]; then
                show_item_help "FUNC" "$func" "${functions[$func]}"
                found=true
            fi
        done
    else
        # Fallback for bash 3
        while IFS='|' read -r type name desc usage cat; do
            if [ "$cat" = "$category" ]; then
                show_item_help "$type" "$name" "$desc|$usage|$cat"
                found=true
            fi
        done < "$HELP_DB"
    fi
    
    if [ "$found" = false ]; then
        echo "No items found in category: $category"
    fi
}

# Main help function
show_help() {
    local topic="$1"
    
    # Initialize arrays (only if bash 4+)
    if [ "${BASH_VERSION%%.*}" -ge 4 ] 2>/dev/null; then
        declare -A commands
        declare -A aliases
        declare -A functions
        declare -A libraries
        declare -A utilities
    fi
    
    load_help_db
    
    # If no topic or "help", show general help
    if [ -z "$topic" ] || [ "$topic" = "help" ]; then
        echo -e "${BOLD}${CYAN}Oh My Bash - Unified Help System${RESET}\n"
        echo -e "Usage: ${GREEN}omb${RESET} [command] [topic]"
        echo
        echo -e "${BOLD}Commands:${RESET}"
        echo -e "  ${GREEN}omb help${RESET}              Show this help"
        echo -e "  ${GREEN}omb list${RESET}              List all available items"
        echo -e "  ${GREEN}omb search <query>${RESET}    Search for items"
        echo -e "  ${GREEN}omb category <name>${RESET}   Show items in category"
        echo -e "  ${GREEN}omb <item>${RESET}            Show help for specific item"
        echo
        echo -e "${BOLD}Categories:${RESET}"
        echo -e "  ${YELLOW}core${RESET}         Core framework components"
        echo -e "  ${YELLOW}system${RESET}       System utilities"
        echo -e "  ${YELLOW}development${RESET}   Development tools"
        echo -e "  ${YELLOW}docker${RESET}       Docker utilities"
        echo -e "  ${YELLOW}git${RESET}          Git tools"
        echo -e "  ${YELLOW}editor${RESET}        Editor utilities"
        echo -e "  ${YELLOW}file${RESET}          File operations"
        echo -e "  ${YELLOW}navigation${RESET}    Navigation shortcuts"
        echo -e "  ${YELLOW}colors${RESET}        Color utilities"
        echo -e "  ${YELLOW}media${RESET}         Media tools"
        echo -e "  ${YELLOW}tmux${RESET}          Tmux configuration"
        echo -e "  ${YELLOW}utilities${RESET}     General utilities"
        echo
        echo -e "${BOLD}Examples:${RESET}"
        echo -e "  ${GREEN}omb d${RESET}                  Show help for 'd' command"
        echo -e "  ${GREEN}omb search docker${RESET}      Search for docker-related items"
        echo -e "  ${GREEN}omb category development${RESET} Show all development tools"
        return 0
    fi
    
    # Handle commands
    case "$topic" in
        list)
            echo -e "${BOLD}${CYAN}Available Items:${RESET}\n"
            
            echo -e "${BOLD}${GREEN}Commands:${RESET}"
            if [ "${BASH_VERSION%%.*}" -ge 4 ] 2>/dev/null; then
                for cmd in "${!commands[@]}"; do
                    IFS='|' read -r desc usage cat <<< "${commands[$cmd]}"
                    echo -e "  ${GREEN}$cmd${RESET} - $desc"
                done | sort
            else
                while IFS='|' read -r type name desc usage cat; do
                    echo -e "  ${GREEN}$name${RESET} - $desc"
                done < "$OH_MY_BASH/.help_cache/commands" | sort
            fi
            
            echo
            echo -e "${BOLD}${YELLOW}Aliases:${RESET}"
            if [ "${BASH_VERSION%%.*}" -ge 4 ] 2>/dev/null; then
                for alias in "${!aliases[@]}"; do
                    IFS='|' read -r desc usage cat <<< "${aliases[$alias]}"
                    echo -e "  ${YELLOW}$alias${RESET} - $desc"
                done | sort
            else
                while IFS='|' read -r type name desc usage cat; do
                    echo -e "  ${YELLOW}$name${RESET} - $desc"
                done < "$OH_MY_BASH/.help_cache/aliases" | sort
            fi
            
            echo
            echo -e "${BOLD}${MAGENTA}Functions:${RESET}"
            if [ "${BASH_VERSION%%.*}" -ge 4 ] 2>/dev/null; then
                for func in "${!functions[@]}"; do
                    IFS='|' read -r desc usage cat <<< "${functions[$func]}"
                    echo -e "  ${MAGENTA}$func${RESET} - $desc"
                done | sort
            else
                while IFS='|' read -r type name desc usage cat; do
                    echo -e "  ${MAGENTA}$name${RESET} - $desc"
                done < "$OH_MY_BASH/.help_cache/functions" | sort
            fi
            
            echo
            echo -e "${BOLD}${BLUE}Libraries:${RESET}"
            if [ "${BASH_VERSION%%.*}" -ge 4 ] 2>/dev/null; then
                for lib in "${!libraries[@]}"; do
                    IFS='|' read -r desc usage cat <<< "${libraries[$lib]}"
                    echo -e "  ${BLUE}$lib${RESET} - $desc"
                done | sort
            else
                while IFS='|' read -r type name desc usage cat; do
                    echo -e "  ${BLUE}$name${RESET} - $desc"
                done < "$OH_MY_BASH/.help_cache/libraries" | sort
            fi
            
            echo
            echo -e "${BOLD}${BLUE}Utilities:${RESET}"
            if [ "${BASH_VERSION%%.*}" -ge 4 ] 2>/dev/null; then
                for util in "${!utilities[@]}"; do
                    IFS='|' read -r desc usage cat <<< "${utilities[$util]}"
                    echo -e "  ${BLUE}$util${RESET} - $desc"
                done | sort
            else
                while IFS='|' read -r type name desc usage cat; do
                    echo -e "  ${BLUE}$name${RESET} - $desc"
                done < "$OH_MY_BASH/.help_cache/utilities" | sort
            fi
            ;;
        search)
            if [ -z "$2" ]; then
                echo "Usage: omb search <query>"
                return 1
            fi
            local query="$2"
                local results=($(search_help "$query"))
                
                if [ ${#results[@]} -eq 0 ]; then
                    echo "No results found for: $query"
                    return 1
                fi
                
                echo -e "${BOLD}${CYAN}Search Results for: $query${RESET}\n"
                for result in "${results[@]}"; do
                    IFS='|' read -r type name desc usage category <<< "$result"
                    if [ -n "$type" ] && [ -n "$name" ]; then
                        show_item_help "$type" "$name" "$desc|$usage|$category"
                    fi
                done
            ;;
        category)
            if [ -z "$2" ]; then
                echo "Usage: omb category <name>"
                echo "Available categories: core system development docker git editor file navigation colors media tmux utilities"
                return 1
            fi
            show_category "$2"
            ;;
        *)
            # Try to find the item
            local found=false
            
            if [ "${BASH_VERSION%%.*}" -ge 4 ] 2>/dev/null; then
                if [ -n "${commands[$topic]}" ]; then
                    show_item_help "CMD" "$topic" "${commands[$topic]}"
                    found=true
                elif [ -n "${aliases[$topic]}" ]; then
                    show_item_help "ALIAS" "$topic" "${aliases[$topic]}"
                    found=true
                elif [ -n "${functions[$topic]}" ]; then
                    show_item_help "FUNC" "$topic" "${functions[$topic]}"
                    found=true
                elif [ -n "${libraries[$topic]}" ]; then
                    show_item_help "LIB" "$topic" "${libraries[$topic]}"
                    found=true
                elif [ -n "${utilities[$topic]}" ]; then
                    show_item_help "UTIL" "$topic" "${utilities[$topic]}"
                    found=true
                fi
            else
                # Fallback for bash 3: use grep
                local result=$(grep "^CMD|$topic|" "$HELP_DB" 2>/dev/null | head -1)
                if [ -n "$result" ]; then
                    IFS='|' read -r type name desc usage cat <<< "$result"
                    show_item_help "$type" "$name" "$desc|$usage|$cat"
                    found=true
                else
                    result=$(grep "^ALIAS|$topic|" "$HELP_DB" 2>/dev/null | head -1)
                    if [ -n "$result" ]; then
                        IFS='|' read -r type name desc usage cat <<< "$result"
                        show_item_help "$type" "$name" "$desc|$usage|$cat"
                        found=true
                    else
                        result=$(grep "^FUNC|$topic|" "$HELP_DB" 2>/dev/null | head -1)
                        if [ -n "$result" ]; then
                            IFS='|' read -r type name desc usage cat <<< "$result"
                            show_item_help "$type" "$name" "$desc|$usage|$cat"
                            found=true
                        fi
                    fi
                fi
            fi
            
            if [ "$found" = false ]; then
                # Try fuzzy search
                local results=($(search_help "$topic"))
                if [ ${#results[@]} -gt 0 ]; then
                    echo -e "${BOLD}${YELLOW}Did you mean one of these?${RESET}\n"
                    for result in "${results[@]}"; do
                        IFS='|' read -r type name desc usage category <<< "$result"
                        if [ -n "$type" ] && [ -n "$name" ]; then
                            show_item_help "$type" "$name" "$desc|$usage|$category"
                        fi
                    done
                else
                    echo "No help found for: $topic"
                    echo "Try: omb search $topic"
                    return 1
                fi
            fi
            ;;
    esac
}

# Main
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    show_help "$@"
fi
