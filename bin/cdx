#!/usr/bin/env bash
set -euo pipefail

# cdx: fast auto-update for @openai/codex using GitHub releases.
# - Detects latest via curl+jq (no npm view)
# - Caches last installed version
# - Shows a spinner while checking
# - Launches codex with all args

CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/cdx"
CACHE_FILE="$CACHE_DIR/version"
mkdir -p "$CACHE_DIR" 2>/dev/null || true

# Spinner helpers
SPIN_PID=""
start_spinner() {
  # Usage: start_spinner "Message"
  local msg="$1"
  local spin='/-\|'
  local i=0
  printf "%s " "$msg"
  (
    while :; do
      i=$(( (i + 1) % 4 ))
      printf "\r%s %s" "$msg" "${spin:$i:1}"
      sleep 0.12
    done
  ) & SPIN_PID=$!
}
stop_spinner() {
  if [ -n "${SPIN_PID:-}" ] && kill -0 "$SPIN_PID" 2>/dev/null; then
    kill "$SPIN_PID" 2>/dev/null || true
    wait "$SPIN_PID" 2>/dev/null || true
  fi
  SPIN_PID=""
  printf "\r"
}
trap 'stop_spinner 2>/dev/null || true' EXIT

# Ensure codex is available
if ! command -v codex >/dev/null 2>&1; then
  echo "codex is not installed or not in PATH." >&2
  exit 127
fi

# Determine installed version (from binary, fallback to cache)
installed=""
installed=$(codex --version 2>/dev/null | grep -Eo '[0-9]+(\.[0-9]+){1,3}' | head -n1 || true)
if [ -z "$installed" ] && [ -f "$CACHE_FILE" ]; then
  installed=$(cat "$CACHE_FILE" 2>/dev/null || true)
fi

# Fetch latest version via GitHub releases
latest=""
if command -v curl >/dev/null 2>&1; then
  start_spinner "Checking for new version"
  if command -v jq >/dev/null 2>&1; then
    latest=$(curl -fsSL https://api.github.com/repos/openai/codex/releases/latest \
      | jq -r '.tag_name' | sed 's/^rust-v//' | sed 's/^[vV]//') || true
  else
    # Fallback parser if jq is unavailable
    latest=$(curl -fsSL https://api.github.com/repos/openai/codex/releases/latest \
      | grep -Eo '"tag_name"\s*:\s*"[^"]+"' | head -n1 | sed -E 's/.*"([^"]+)".*/\1/' \
      | sed -E 's/^(rust-)?[vV]//') || true
  fi
  stop_spinner
fi

# Function: version compare using sort -V
# Return 0 (true) if $1 < $2, else 1 (false)
ver_lt() {
  [ "$1" != "$2" ] || return 1
  printf '%s\n%s\n' "$1" "$2" | sort -V -C 2>/dev/null
}

need_update=0
if [ -n "$latest" ]; then
  if [ -z "$installed" ] || ver_lt "$installed" "$latest"; then
    need_update=1
  fi
fi

if [ "$need_update" -eq 1 ]; then
  echo "New Codex available (${installed:-unknown} -> $latest). Updating..."
  if command -v npm >/dev/null 2>&1; then
    # Install specific latest version; show npm output to indicate progress
    if npm install -g "@openai/codex@$latest"; then
      hash -r 2>/dev/null || true
      echo "$latest" > "$CACHE_FILE" 2>/dev/null || true
      echo "Codex updated to $latest."
    else
      echo "Auto-update failed; launching current Codex ${installed:-unknown}."
    fi
  else
    echo "npm not found; cannot auto-update. Launching current Codex ${installed:-unknown}."
  fi
else
  if [ -n "$latest" ] && [ -n "$installed" ]; then
    echo "Codex is up to date ($installed)."
  fi
fi

# Launch Codex with original arguments
exec codex "$@"
